<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gestionar Usuarios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        .badge-admin {
            background-color: #28a745;
            color: white;
        }
        .badge-user {
            background-color: #007bff;
            color: white;
        }
        .badge-artist {
            background-color: #6f42c1;
            color: white;
        }
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        .action-buttons button {
            margin-right: 5px;
        }
        .confirmation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .confirmation-box {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center">Administrar Usuarios</h2>

    <!-- Indicador de carga -->
    <div id="loading-indicator" class="text-center" style="display:none;">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>

    <!-- Tabla de usuarios -->
    <table class="table table-bordered mt-3" id="users-table" style="display:none;">
        <thead>
        <tr>
            <th>#</th>
            <th>Username</th>
            <th>Nombre</th>
            <th>Apellido</th>
            <th>Email</th>
            <th>Rol</th>
            <th>Acciones</th>
        </tr>
        </thead>
        <tbody id="users-table-body">
        </tbody>
    </table>

    <!-- Botón de actualizar -->
    <button id="refresh-btn" class="btn btn-primary">Actualizar</button>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="confirmation-modal" id="confirmation-modal">
    <div class="confirmation-box">
        <div class="mb-4">
            <i class="fas fa-exclamation-triangle text-warning" style="font-size: 50px;"></i>
        </div>
        <h4>¿Estás seguro?</h4>
        <p class="mb-4" id="confirmation-message">Esta acción no se puede deshacer.</p>
        <div class="d-flex justify-content-center">
            <button class="btn btn-secondary me-3" id="cancel-action">Cancelar</button>
            <button class="btn btn-danger" id="confirm-action">Confirmar</button>
        </div>
    </div>
</div>

<!-- Modal para cambiar rol -->
<div class="confirmation-modal" id="role-modal">
    <div class="confirmation-box">
        <h4>Cambiar Rol de Usuario</h4>
        <p class="mb-3" id="role-user-info"></p>
        <div class="mb-3">
            <label for="new-role" class="form-label">Seleccionar nuevo rol:</label>
            <select class="form-select" id="new-role">
                <option value="USER">USER</option>
                <option value="ARTIST">ARTIST</option>
                <option value="ADMIN">ADMIN</option>
            </select>
        </div>
        <div class="d-flex justify-content-center">
            <button class="btn btn-secondary me-3" id="cancel-role">Cancelar</button>
            <button class="btn btn-primary" id="confirm-role">Cambiar Rol</button>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function() {
        let currentUsers = [];
        let currentAction = { type: '', username: '' };

        // Cargar usuarios al iniciar
        loadUsers();

        $('#refresh-btn').click(function() {
            loadUsers();
        });

        // Configurar modales
        $('#cancel-action').click(function() {
            $('#confirmation-modal').fadeOut();
        });

        $('#cancel-role').click(function() {
            $('#role-modal').fadeOut();
        });

        $(window).click(function(event) {
            if (event.target.id === 'confirmation-modal') {
                $('#confirmation-modal').fadeOut();
            }
            if (event.target.id === 'role-modal') {
                $('#role-modal').fadeOut();
            }
        });

        function loadUsers() {
            $('#loading-indicator').show();
            $('#users-table').hide();

            $.ajax({
                url: 'http://localhost:8080/users/all',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    currentUsers = data;
                    populateUsersTable(data);
                    $('#loading-indicator').hide();
                    $('#users-table').show();
                },
                error: function(xhr, status, error) {
                    console.error("Error al cargar los usuarios: ", error);
                    $('#loading-indicator').hide();
                    alert('Error al cargar los usuarios: ' + error);
                }
            });
        }

        function populateUsersTable(users) {
            $('#users-table-body').empty();

            users.forEach(function(user, index) {
                let row = $('<tr>');

                row.append($('<td>').text(index + 1));
                row.append($('<td>').text(user.username || 'No especificado'));
                row.append($('<td>').text(user.name || 'Sin nombre'));
                row.append($('<td>').text(user.surname || 'Sin apellido'));
                row.append($('<td>').text(user.email));

                let roleBadge = $('<span>').addClass('badge');
                if (user.role === 'ADMIN') {
                    roleBadge.addClass('badge-admin').text('ADMIN');
                } else if (user.role === 'ARTIST') {
                    roleBadge.addClass('badge-artist').text('ARTIST');
                } else {
                    roleBadge.addClass('badge-user').text('USER');
                }
                row.append($('<td>').append(roleBadge));

                let actionButtons = $('<div>').addClass('action-buttons d-flex flex-wrap');

                // Botón Cambiar Rol
                actionButtons.append(
                    $('<button>')
                        .addClass('btn btn-info btn-sm me-2 mb-1')
                        .html('<i class="fas fa-user-cog me-1"></i>Cambiar Rol')
                        .click(function() {
                            showRoleModal(user);
                        })
                );

                // Botón Eliminar
                actionButtons.append(
                    $('<button>')
                        .addClass('btn btn-danger btn-sm mb-1')
                        .html('<i class="fas fa-times me-1"></i>Eliminar')
                        .click(function() {
                            showDeleteConfirmation(user.username);
                        })
                );

                row.append($('<td>').append(actionButtons));
                $('#users-table-body').append(row);
            });
        }

        function showRoleModal(user) {
            currentAction = { type: 'changeRole', username: user.username };
            $('#role-user-info').text(`Cambiar rol de: ${user.username} (Rol actual: ${user.role})`);
            $('#new-role').val(user.role);
            $('#role-modal').fadeIn();
        }

        function showDeleteConfirmation(username) {
            currentAction = { type: 'delete', username: username };
            $('#confirmation-message').text(`¿Estás seguro de que quieres eliminar al usuario "${username}"? Esta acción no se puede deshacer.`);
            $('#confirmation-modal').fadeIn();
        }

        // Confirmar cambio de rol
        $('#confirm-role').click(function() {
            const newRole = $('#new-role').val();
            changeUserRole(currentAction.username, newRole);
        });

        // Confirmar eliminación
        $('#confirm-action').click(function() {
            if (currentAction.type === 'delete') {
                deleteUser(currentAction.username);
            }
        });

        function changeUserRole(username, newRole) {
            $.ajax({
                url: `http://localhost:8080/users/${username}/role`,
                method: 'PATCH',
                contentType: 'application/json',
                data: JSON.stringify({
                    role: newRole
                }),
                success: function(response) {
                    alert(`Rol de ${username} actualizado a: ${newRole}`);
                    $('#role-modal').fadeOut();
                    loadUsers();
                },
                error: function(xhr, status, error) {
                    console.error('Error al cambiar rol:', error);
                    let errorMessage = 'Error al cambiar el rol';

                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage += ': ' + xhr.responseJSON.message;
                    }

                    alert(errorMessage);
                }
            });
        }

        function deleteUser(username) {
            $.ajax({
                url: 'http://localhost:8080/users',
                method: 'DELETE',
                headers: {
                    'username': username
                },
                success: function(response) {
                    alert(`Usuario ${username} eliminado correctamente`);
                    $('#confirmation-modal').fadeOut();
                    loadUsers();
                },
                error: function(xhr, status, error) {
                    console.error('Error al eliminar usuario:', error);
                    let errorMessage = 'Error al eliminar el usuario';

                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage += ': ' + xhr.responseJSON.message;
                    }

                    alert(errorMessage);
                }
            });
        }
    });
</script>
</body>
</html>