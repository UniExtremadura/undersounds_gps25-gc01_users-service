<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artistas - MusicApp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 20px;
        }
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .artists-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .artist-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 20px;
            height: 100%;
        }
        .artist-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .artist-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 30px;
            margin: 0 auto 15px;
        }
        .artist-name {
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        .artist-genres {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
            justify-content: center;
        }
        .genre-badge {
            background-color: #6a11cb;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
        }
        .follow-btn {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }
        .follow-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .unfollow-btn {
            background: #6c757d;
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }
        .unfollow-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        .followers-count {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 10px;
        }
        .section-title {
            font-weight: 600;
            margin-bottom: 20px;
            color: #495057;
            border-bottom: 2px solid #6a11cb;
            padding-bottom: 10px;
        }
        .followed-artists {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .followed-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .followed-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .followed-item:last-child {
            border-bottom: none;
        }
        .empty-followed {
            text-align: center;
            color: #6c757d;
            padding: 20px;
        }
        .search-container {
            margin-bottom: 20px;
        }
        .search-input {
            border-radius: 20px;
            padding: 10px 20px;
            border: 1px solid #ddd;
        }
        .filter-container {
            margin-bottom: 20px;
        }
        .filter-select {
            border-radius: 20px;
            padding: 10px 20px;
        }
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .btn-profile {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: 600;
        }
        .btn-profile:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .trending-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffc107;
            color: #212529;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .alert-message {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
        }
    </style>
</head>
<body>
<div class="container artists-container">
    <div class="header text-center">
        <h1><i class="fas fa-music me-2"></i>Explorar Artistas</h1>
        <p class="mb-0">Descubre y sigue a tus artistas favoritos</p>
    </div>

    <div class="nav-buttons">
        <button class="btn btn-outline-secondary" id="back-to-profile">
            <i class="fas fa-arrow-left me-2"></i>Volver al Perfil
        </button>
        <button class="btn-profile" id="go-to-profile">
            <i class="fas fa-user me-2"></i>Mi Perfil
        </button>
    </div>

    <!-- Sección de artistas seguidos -->
    <div class="followed-artists">
        <h3 class="section-title">Artistas que sigo</h3>
        <div class="followed-list" id="followed-list">
            <div class="empty-followed">
                <i class="fas fa-users fa-2x mb-3"></i>
                <p>No sigues a ningún artista todavía</p>
                <p class="small">¡Descubre artistas y empieza a seguir a tus favoritos!</p>
            </div>
        </div>
    </div>

    <!-- Filtros y búsqueda -->
    <div class="row">
        <div class="col-md-8">
            <div class="search-container">
                <input type="text" class="form-control search-input" id="search-input" placeholder="Buscar artistas por nombre...">
            </div>
        </div>
        <div class="col-md-4">
            <div class="filter-container">
                <select class="form-control filter-select" id="genre-filter">
                    <option value="">Todos los géneros</option>
                    <!-- Los géneros se cargarán dinámicamente -->
                </select>
            </div>
        </div>
    </div>

    <!-- Lista de artistas -->
    <h3 class="section-title">Todos los Artistas</h3>
    <div class="row" id="artists-grid">
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando artistas...</span>
            </div>
            <p class="mt-2">Cargando artistas...</p>
        </div>
    </div>

    <!-- Trending artists -->
    <h3 class="section-title mt-5">Artistas en Tendencia</h3>
    <div class="row" id="trending-artists">
        <div class="col-12 text-center">
            <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">Cargando tendencias...</span>
            </div>
            <p class="mt-2">Cargando artistas en tendencia...</p>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Lista de géneros musicales
    const musicGenres = [
        "HIP_HOP", "RAP", "TRAP", "RNB", "POP", "ROCK", "ALTERNATIVE_ROCK", "HARD_ROCK",
        "PUNK_ROCK", "METAL", "HEAVY_METAL", "TRASH_METAL", "INDIE", "INDIE_ROCK",
        "INDIE_POP", "ELECTRONIC", "EDM", "HOUSE", "TECHNO", "TRANCE", "DUBSTEP",
        "DRUM_AND_BASS", "JAZZ", "BLUES", "FUNK", "SOUL", "CLASSICAL", "REGGAE",
        "REGGAETON", "SALSA", "BACHATA", "CUMBIA", "FLAMENCO", "FOLK", "COUNTRY",
        "LATIN", "AFROBEAT", "K_POP", "J_POP", "LOFI", "AMBIENT", "EXPERIMENTAL",
        "INSTRUMENTAL", "ACOUSTIC", "SOUNDTRACK", "GOSPEL", "OPERA", "DANCEHALL",
        "DISCO", "GRIME", "DRILL", "PHONK", "CHILLWAVE", "SYNTHWAVE", "NEW_WAVE"
    ];

    // Variables globales
    let allArtists = [];
    let followedArtists = [];
    let currentUser = null;

    $(document).ready(function() {
        // Verificar si hay un usuario logueado
        currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            alert('Debes iniciar sesión para acceder a esta página');
            window.location.href = 'profile.html';
            return;
        }

        // Cargar géneros en el filtro
        loadGenresFilter();

        // Cargar artistas
        loadArtists();

        // Cargar artistas seguidos
        loadFollowedArtists();

        // Cargar artistas en tendencia
        loadTrendingArtists();

        // Configurar eventos
        $('#search-input').on('input', filterArtists);
        $('#genre-filter').change(filterArtists);
        $('#back-to-profile').click(function() {
            window.location.href = 'profile.html';
        });
        $('#go-to-profile').click(function() {
            window.location.href = 'profile.html';
        });
    });

    // Función para cargar géneros en el filtro
    function loadGenresFilter() {
        const genreFilter = $('#genre-filter');
        musicGenres.forEach(genre => {
            genreFilter.append(`<option value="${genre}">${formatGenreName(genre)}</option>`);
        });
    }

    // Función para formatear el nombre del género
    function formatGenreName(genre) {
        return genre.toLowerCase()
            .split('_')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }

    // Función para cargar todos los artistas desde /users/all
    function loadArtists() {
        console.log("Cargando artistas desde /users/all...");

        $.ajax({
            url: 'http://localhost:8080/users/all',
            method: 'GET',
            success: function(response) {
                console.log("Todos los usuarios cargados:", response);

                if (response && Array.isArray(response)) {
                    // Filtrar solo los usuarios con rol ARTIST
                    const artists = response.filter(user => user.role === 'ARTIST');
                    console.log("Artistas encontrados:", artists.length);
                    console.log("Artistas:", artists);

                    // Para cada artista, cargar sus géneros y contador de seguidores
                    loadArtistsDetails(artists);
                } else {
                    showError("No se pudieron cargar los artistas - Formato inválido");
                }
            },
            error: function(xhr, status, error) {
                console.error('Error al cargar usuarios:', error);
                showError("Error al cargar artistas. Verifica la conexión.");
            }
        });
    }

    // Función para cargar detalles adicionales de cada artista
    function loadArtistsDetails(artists) {
        const artistsWithDetails = [];
        let loadedCount = 0;

        if (artists.length === 0) {
            showError("No se encontraron artistas");
            return;
        }

        artists.forEach(artist => {
            // Cargar géneros del artista
            $.ajax({
                url: `http://localhost:8080/users/${artist.username}`,
                method: 'GET',
                success: function(userDetails) {
                    console.log(`Detalles de ${artist.username}:`, userDetails);

                    const artistWithDetails = {
                        username: artist.username,
                        name: artist.name || artist.username,
                        bio: artist.bio || userDetails.bio || '',
                        followersCount: userDetails.followersCount || 0,
                        genres: userDetails.favoriteGenres || [],
                        trending: false
                    };

                    artistsWithDetails.push(artistWithDetails);
                    loadedCount++;

                    // Cuando todos los artistas estén cargados
                    if (loadedCount === artists.length) {
                        allArtists = artistsWithDetails;
                        console.log("Todos los artistas cargados:", allArtists);
                        displayArtists(allArtists);
                    }
                },
                error: function() {
                    // Si falla, usar datos básicos
                    const artistWithDetails = {
                        username: artist.username,
                        name: artist.name || artist.username,
                        bio: artist.bio || '',
                        followersCount: 0,
                        genres: [],
                        trending: false
                    };

                    artistsWithDetails.push(artistWithDetails);
                    loadedCount++;

                    if (loadedCount === artists.length) {
                        allArtists = artistsWithDetails;
                        console.log("Artistas cargados (con fallos):", allArtists);
                        displayArtists(allArtists);
                    }
                }
            });
        });
    }

    // Función para mostrar artistas en la cuadrícula
    function displayArtists(artists) {
        const artistsGrid = $('#artists-grid');
        artistsGrid.empty();

        if (artists.length === 0) {
            artistsGrid.html('<div class="col-12 text-center text-muted">No se encontraron artistas</div>');
            return;
        }

        console.log("Mostrando", artists.length, "artistas");

        artists.forEach(artist => {
            const isFollowed = followedArtists.some(followed => followed.username === artist.username);

            const artistCard = `
                <div class="col-md-4 col-lg-3 mb-4">
                    <div class="artist-card position-relative">
                        ${artist.trending ? '<span class="trending-badge"><i class="fas fa-fire me-1"></i>Tendencia</span>' : ''}
                        <div class="p-3 text-center">
                            <div class="artist-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <h5 class="artist-name">${artist.username}</h5>
                            <div class="artist-genres">
                                ${artist.genres && artist.genres.slice(0, 2).map(genre =>
                                    `<span class="genre-badge">${formatGenreName(genre)}</span>`
                                ).join('')}
                                ${artist.genres && artist.genres.length > 2 ?
                                    `<span class="genre-badge">+${artist.genres.length - 2}</span>` : ''}
                                ${(!artist.genres || artist.genres.length === 0) ?
                                    '<span class="text-muted small">Sin géneros</span>' : ''}
                            </div>
                            <div class="followers-count">
                                <i class="fas fa-users me-1"></i>${artist.followersCount} seguidores
                            </div>
                            <button class="${isFollowed ? 'unfollow-btn' : 'follow-btn'}"
                                    data-username="${artist.username}"
                                    onclick="toggleFollow('${artist.username}')">
                                <i class="fas ${isFollowed ? 'fa-user-minus' : 'fa-user-plus'} me-1"></i>
                                ${isFollowed ? 'Dejar de seguir' : 'Seguir'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            artistsGrid.append(artistCard);
        });
    }

    // Función para cargar artistas seguidos
    function loadFollowedArtists() {
        $.ajax({
            url: `http://localhost:8080/follows/following/${currentUser.username}`,
            method: 'GET',
            success: function(response) {
                console.log("Artistas seguidos:", response);
                if (response && Array.isArray(response)) {
                    followedArtists = response.map(artist => ({
                        username: artist.username,
                        name: artist.name,
                        bio: artist.bio,
                        followersCount: artist.followers_count || 0,
                        genres: artist.genres ? artist.genres.split(',') : []
                    }));
                    displayFollowedArtists();
                } else {
                    followedArtists = [];
                    displayFollowedArtists();
                }
            },
            error: function(xhr, status, error) {
                console.error('Error al cargar artistas seguidos:', error);
                followedArtists = [];
                displayFollowedArtists();
            }
        });
    }

    // Función para mostrar artistas seguidos
    function displayFollowedArtists() {
        const followedList = $('#followed-list');
        followedList.empty();

        if (followedArtists.length === 0) {
            followedList.html(`
                <div class="empty-followed">
                    <i class="fas fa-users fa-2x mb-3"></i>
                    <p>No sigues a ningún artista todavía</p>
                    <p class="small">¡Descubre artistas y empieza a seguir a tus favoritos!</p>
                </div>
            `);
            return;
        }

        followedArtists.forEach(artist => {
            const followedItem = `
                <div class="followed-item">
                    <div>
                        <strong>${artist.username}</strong>
                        <div class="small text-muted">
                            ${artist.genres && artist.genres.length > 0 ?
                                artist.genres.slice(0, 2).map(g => formatGenreName(g)).join(', ') :
                                'Sin géneros'}
                            ${artist.followersCount > 0 ? ` • ${artist.followersCount} seguidores` : ''}
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="unfollowArtist('${artist.username}')">
                        <i class="fas fa-user-minus"></i> Dejar de seguir
                    </button>
                </div>
            `;
            followedList.append(followedItem);
        });
    }

    // Función para cargar artistas en tendencia
    function loadTrendingArtists() {
        $.ajax({
            url: 'http://localhost:8080/follows/trending?limit=6',
            method: 'GET',
            success: function(response) {
                console.log("Artistas en tendencia:", response);
                if (response && Array.isArray(response)) {
                    displayTrendingArtists(response);
                } else {
                    $('#trending-artists').html('<div class="col-12 text-center text-muted">No hay artistas en tendencia en este momento</div>');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error al cargar artistas en tendencia:', error);
                $('#trending-artists').html('<div class="col-12 text-center text-muted">No se pudieron cargar los artistas en tendencia</div>');
            }
        });
    }

    // Función para mostrar artistas en tendencia
    function displayTrendingArtists(artists) {
        const trendingContainer = $('#trending-artists');
        trendingContainer.empty();

        if (artists.length === 0) {
            trendingContainer.html('<div class="col-12 text-center text-muted">No hay artistas en tendencia en este momento</div>');
            return;
        }

        artists.forEach(artist => {
            const isFollowed = followedArtists.some(followed => followed.username === artist.username);

            const artistCard = `
                <div class="col-md-3 col-lg-2 mb-4">
                    <div class="artist-card position-relative">
                        <span class="trending-badge"><i class="fas fa-fire me-1"></i>Tendencia</span>
                        <div class="p-3 text-center">
                            <div class="artist-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <h6 class="artist-name">${artist.username}</h6>
                            <div class="followers-count small">
                                <i class="fas fa-users me-1"></i>${artist.followers_count || 0}
                            </div>
                            <button class="${isFollowed ? 'unfollow-btn' : 'follow-btn'} btn-sm"
                                    data-username="${artist.username}"
                                    onclick="toggleFollow('${artist.username}')">
                                <i class="fas ${isFollowed ? 'fa-user-minus' : 'fa-user-plus'}"></i>
                                ${isFollowed ? 'Dejar' : 'Seguir'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            trendingContainer.append(artistCard);
        });
    }

    // Función para seguir/dejar de seguir artista
    function toggleFollow(artistUsername) {
        console.log("Intentando seguir/dejar de seguir:", artistUsername);
        console.log("Usuario actual:", currentUser.username);

        // Verificar si está intentando seguirse a sí mismo
        if (currentUser.username === artistUsername) {
            showMessage('No puedes seguirte a ti mismo', 'error');
            return;
        }

        const isCurrentlyFollowed = followedArtists.some(artist => artist.username === artistUsername);

        if (isCurrentlyFollowed) {
            unfollowArtist(artistUsername);
        } else {
            followArtist(artistUsername);
        }
    }

    // Función para seguir artista
    function followArtist(artistUsername) {
        $.ajax({
            url: `http://localhost:8080/follows?followerUsername=${currentUser.username}&followedUsername=${artistUsername}`,
            method: 'POST',
            success: function(response) {
                console.log("Respuesta del servidor al seguir:", response);

                // Actualizar lista de seguidos
                const artist = allArtists.find(a => a.username === artistUsername);
                if (artist) {
                    followedArtists.push(artist);
                    displayFollowedArtists();

                    // Actualizar botones en la lista de artistas
                    $(`button[data-username="${artistUsername}"]`)
                        .removeClass('follow-btn')
                        .addClass('unfollow-btn')
                        .html('<i class="fas fa-user-minus me-1"></i>Dejar de seguir');

                    // Actualizar contador
                    if (response.followersCount !== undefined) {
                        artist.followersCount = response.followersCount;
                        $(`button[data-username="${artistUsername}"]`).closest('.artist-card')
                            .find('.followers-count').html(`<i class="fas fa-users me-1"></i>${response.followersCount} seguidores`);
                    }
                }

                showMessage(`Ahora sigues a ${artistUsername}`, 'success');
            },
            error: function(xhr, status, error) {
                console.error('Error al seguir artista:', error);
                console.log('Status:', xhr.status);
                console.log('Response:', xhr.responseText);

                if (xhr.status === 409) {
                    showMessage('Ya sigues a este artista', 'error');
                } else if (xhr.status === 400) {
                    showMessage('No puedes seguirte a ti mismo', 'error');
                } else {
                    showMessage('Error al seguir al artista', 'error');
                }
            }
        });
    }

    // Función para dejar de seguir artista
    function unfollowArtist(artistUsername) {
        $.ajax({
            url: `http://localhost:8080/follows?followerUsername=${currentUser.username}&followedUsername=${artistUsername}`,
            method: 'DELETE',
            success: function(response) {
                console.log("Respuesta del servidor al dejar de seguir:", response);

                // Actualizar lista de seguidos
                followedArtists = followedArtists.filter(artist => artist.username !== artistUsername);
                displayFollowedArtists();

                // Actualizar botones en la lista de artistas
                $(`button[data-username="${artistUsername}"]`)
                    .removeClass('unfollow-btn')
                    .addClass('follow-btn')
                    .html('<i class="fas fa-user-plus me-1"></i>Seguir');

                // Actualizar contador
                if (response.followersCount !== undefined) {
                    const artist = allArtists.find(a => a.username === artistUsername);
                    if (artist) {
                        artist.followersCount = response.followersCount;
                        $(`button[data-username="${artistUsername}"]`).closest('.artist-card')
                            .find('.followers-count').html(`<i class="fas fa-users me-1"></i>${response.followersCount} seguidores`);
                    }
                }

                showMessage(`Has dejado de seguir a ${artistUsername}`, 'info');
            },
            error: function(xhr, status, error) {
                console.error('Error al dejar de seguir artista:', error);
                console.log('Status:', xhr.status);
                console.log('Response:', xhr.responseText);
                showMessage('Error al dejar de seguir al artista', 'error');
            }
        });
    }

    // Función para filtrar artistas
    function filterArtists() {
        const searchTerm = $('#search-input').val().toLowerCase();
        const selectedGenre = $('#genre-filter').val();

        let filteredArtists = allArtists;

        // Filtrar por término de búsqueda
        if (searchTerm) {
            filteredArtists = filteredArtists.filter(artist =>
                artist.username.toLowerCase().includes(searchTerm) ||
                (artist.name && artist.name.toLowerCase().includes(searchTerm))
            );
        }

        // Filtrar por género
        if (selectedGenre) {
            filteredArtists = filteredArtists.filter(artist =>
                artist.genres && artist.genres.includes(selectedGenre)
            );
        }

        displayArtists(filteredArtists);
    }

    // Función para mostrar mensajes
    function showMessage(message, type) {
        // Eliminar mensajes anteriores
        $('.alert-message').remove();

        // Crear elemento de mensaje
        const alertClass = type === 'success' ? 'alert-success' :
                         type === 'error' ? 'alert-danger' : 'alert-info';
        const icon = type === 'success' ? 'fa-check-circle' :
                    type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';

        const messageEl = $(`
            <div class="alert ${alertClass} alert-dismissible fade show alert-message" role="alert">
                <i class="fas ${icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);

        // Añadir al body y eliminar después de 4 segundos
        $('body').append(messageEl);
        setTimeout(() => {
            messageEl.alert('close');
        }, 4000);
    }

    // Función para mostrar error
    function showError(message) {
        $('#artists-grid').html(`
            <div class="col-12 text-center">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
                <button class="btn btn-primary mt-2" onclick="loadArtists()">
                    <i class="fas fa-redo me-2"></i>Reintentar
                </button>
            </div>
        `);
    }
</script>
</body>
</html>